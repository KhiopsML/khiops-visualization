<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Khiops-visualization demo</title>
    <link rel="stylesheet" href="./common-header.css" />
  </head>
  <body>
    <div id="header">
      <div id="tabs">
        <button class="tab active" data-component="visualization">
          Khiops Visualization
        </button>
        <button class="tab" data-component="covisualization">
          Khiops Covisualization
        </button>
      </div>
      <div id="version-selector">
        <label for="version-select">Version:</label>
        <select id="version-select">
          <option value="">Loading versions...</option>
        </select>
      </div>
    </div>
    <div id="container"></div>
    <script id="dynamic-script"></script>
    <script src="./common-tabs.js"></script>
    <script>
      let currentVersion = null;

      // Fetch available versions from NPM registry
      async function fetchVersions() {
        try {
          const response = await fetch(
            'https://registry.npmjs.org/khiops-visualization',
          );
          const data = await response.json();
          const versions = Object.keys(data.versions).reverse(); // Latest first
          return versions;
        } catch (error) {
          console.error('Error fetching versions:', error);
          return [];
        }
      }

      // Load script for a specific version
      function loadScript(version) {
        const scriptElement = document.getElementById('dynamic-script');
        const url = version
          ? `https://unpkg.com/khiops-visualization@${version}/khiops-webcomponents.bundle.js`
          : 'https://unpkg.com/khiops-visualization/khiops-webcomponents.bundle.js';

        // Remove old script
        if (scriptElement.src) {
          scriptElement.remove();
          const newScript = document.createElement('script');
          newScript.id = 'dynamic-script';
          newScript.src = url;
          newScript.onload = () => {
            recreateComponent();
          };
          document.body.appendChild(newScript);
        } else {
          scriptElement.src = url;
          scriptElement.onload = () => {
            recreateComponent();
          };
        }
      }

      // Initialize version selector
      async function initVersionSelector() {
        const select = document.getElementById('version-select');
        const versions = await fetchVersions();

        if (versions.length === 0) {
          select.innerHTML =
            '<option value="">Failed to load versions</option>';
          return;
        }

        // Populate select with versions
        select.innerHTML = versions
          .map(
            (version) =>
              `<option value="${version}">${version}${version === versions[0] ? ' (latest)' : ''}</option>`,
          )
          .join('');

        // Set current version to latest
        currentVersion = versions[0];
        select.value = currentVersion;

        // Add change event listener
        select.addEventListener('change', function () {
          const selectedVersion = this.value;
          if (selectedVersion && selectedVersion !== currentVersion) {
            currentVersion = selectedVersion;
            // Reload page without cache
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('v', selectedVersion);
            urlParams.set('component', currentComponent);
            urlParams.set('t', Date.now());
            window.location.href =
              window.location.href.split('?')[0] + '?' + urlParams.toString();
          }
        });

        // Load the selected version from URL or default to latest
        const urlParams = new URLSearchParams(window.location.search);
        const versionParam = urlParams.get('v');
        if (versionParam && versions.includes(versionParam)) {
          currentVersion = versionParam;
          select.value = currentVersion;
        }

        // Load component from URL parameter
        const componentParam = urlParams.get('component');
        if (componentParam && componentConfig[componentParam]) {
          currentComponent = componentParam;
          updateActiveTab();
        }

        loadScript(currentVersion);
      }

      // For external CDN script, use DOMContentLoaded as fallback
      // but add additional check for component availability
      document.addEventListener('DOMContentLoaded', function () {
        initTabs();
        initVersionSelector();
      });
    </script>
  </body>
</html>
