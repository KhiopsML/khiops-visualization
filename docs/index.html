<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Khiops-visualization demo</title>
    <link rel="stylesheet" href="./common-header.css" />
    <style>
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div id="header">
      <div id="tabs">
        <button class="tab active" data-component="visualization">
          Khiops Visualization
        </button>
        <button class="tab" data-component="covisualization">
          Khiops Covisualization
        </button>
      </div>
      <div id="version-selector">
        <label for="version-select">Version:</label>
        <select id="version-select">
          <option value="">Loading versions...</option>
        </select>
      </div>
    </div>
    <div id="container"></div>
    <div
      id="loading-indicator"
      style="
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 1000;
      "
    >
      <div
        style="
          border: 4px solid #f3f3f3;
          border-top: 4px solid #3498db;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
          margin: 0 auto 20px;
        "
      ></div>
      <p
        id="loading-text"
        style="font-family: Arial, sans-serif; color: #666; font-size: 16px"
      >
        Loading Khiops components...
      </p>
    </div>
    <script id="dynamic-script"></script>
    <script src="./common-tabs.js"></script>
    <script>
      let currentVersion = null;

      // Fetch available versions from NPM registry
      async function fetchVersions() {
        try {
          const response = await fetch(
            'https://registry.npmjs.org/khiops-visualization',
          );
          const data = await response.json();
          const versions = Object.keys(data.versions).reverse(); // Latest first
          return versions;
        } catch (error) {
          console.error('Error fetching versions:', error);
          return [];
        }
      }

      // Load script for a specific version
      function loadScript(version) {
        // Update loading text with version info
        const loadingText = document.getElementById('loading-text');
        if (version === 'dev') {
          loadingText.textContent = 'Loading Khiops version development (dev)';
        } else if (version) {
          loadingText.textContent = `Loading Khiops version ${version}`;
        } else {
          loadingText.textContent = 'Loading Khiops latest version';
        }

        // Show loading indicator
        document.getElementById('loading-indicator').style.display = 'block';

        const scriptElement = document.getElementById('dynamic-script');
        let url;

        if (version === 'dev') {
          url = `./dist/khiops-webcomponents.bundle.js?v=${Math.random()}`;
        } else if (version) {
          // Encode version to prevent XSS
          const encodedVersion = encodeURIComponent(version);
          url = `https://cdn.jsdelivr.net/npm/khiops-visualization@${encodedVersion}/khiops-webcomponents.bundle.js`;
        } else {
          url =
            'https://cdn.jsdelivr.net/npm/khiops-visualization/khiops-webcomponents.bundle.js';
        }

        // Remove old script
        if (scriptElement.src) {
          scriptElement.remove();
          const newScript = document.createElement('script');
          newScript.id = 'dynamic-script';
          newScript.src = url;
          newScript.onload = () => {
            document.getElementById('loading-indicator').style.display = 'none';
            recreateComponent();
          };
          document.body.appendChild(newScript);
        } else {
          scriptElement.src = url;
          scriptElement.onload = () => {
            document.getElementById('loading-indicator').style.display = 'none';
            recreateComponent();
          };
        }
      }

      // Initialize version selector
      async function initVersionSelector() {
        const select = document.getElementById('version-select');
        const versions = await fetchVersions();

        if (versions.length === 0) {
          select.innerHTML =
            '<option value="">Failed to load versions</option>';
          return;
        }

        // Build options with dev at top
        let optionsHTML = '<option value="dev">dev (branch master)</option>';
        optionsHTML += '<option disabled>──────────</option>';
        optionsHTML += versions
          .map(
            (version) =>
              `<option value="${version}">${version}${version === versions[0] ? ' (latest)' : ''}</option>`,
          )
          .join('');

        select.innerHTML = optionsHTML;

        // Check URL parameter first
        const urlParams = new URLSearchParams(window.location.search);
        const versionParam = urlParams.get('v');

        if (versionParam === 'dev') {
          currentVersion = 'dev';
        } else if (versionParam && versions.includes(versionParam)) {
          currentVersion = versionParam;
        } else {
          // Default to latest NPM version
          currentVersion = versions[0];
        }

        select.value = currentVersion;

        // Add change event listener
        select.addEventListener('change', function () {
          const selectedVersion = this.value;
          if (selectedVersion && selectedVersion !== currentVersion) {
            currentVersion = selectedVersion;
            // Reload page without cache
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('v', selectedVersion);
            urlParams.set('component', currentComponent);
            urlParams.set('t', Date.now());
            window.location.href =
              window.location.href.split('?')[0] + '?' + urlParams.toString();
          }
        });

        // Load component from URL parameter
        const componentParam = urlParams.get('component');
        if (componentParam && componentConfig[componentParam]) {
          currentComponent = componentParam;
          updateActiveTab();
        }

        loadScript(currentVersion);
      }

      // For external CDN script, use DOMContentLoaded as fallback
      // but add additional check for component availability
      document.addEventListener('DOMContentLoaded', function () {
        initTabs();
        initVersionSelector();
      });
    </script>
  </body>
</html>
