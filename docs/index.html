<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Khiops-visualization demo</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        display: flex;
        flex-direction: column;
      }
      #header {
        background-color: #2c3e50;
        color: white;
        padding: 0;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      #tabs {
        display: flex;
        gap: 0;
        flex: 1;
      }
      .tab {
        padding: 12px 24px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        background-color: #34495e;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
      }
      .tab:hover {
        background-color: #3d566e;
        color: white;
      }
      .tab.active {
        background-color: #2c3e50;
        color: white;
        border-bottom-color: #3498db;
      }
      #version-selector {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 0 20px;
        border-left: 1px solid #34495e;
      }
      #version-selector label {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px;
        font-weight: 500;
        white-space: nowrap;
      }
      #version-select {
        padding: 6px 10px;
        border-radius: 4px;
        border: 1px solid #34495e;
        background-color: #34495e;
        color: white;
        font-size: 14px;
        cursor: pointer;
        outline: none;
        min-width: 150px;
      }
      #version-select:hover {
        background-color: #3d566e;
      }
      #version-select:focus {
        border-color: #3498db;
      }
      #container {
        flex: 1;
        position: relative;
      }
    </style>
  </head>
  <body>
    <div id="header">
      <div id="tabs">
        <button class="tab active" data-component="visualization">
          Khiops Visualization
        </button>
        <button class="tab" data-component="covisualization">
          Khiops Covisualization
        </button>
      </div>
      <div id="version-selector">
        <label for="version-select">Version:</label>
        <select id="version-select">
          <option value="">Loading versions...</option>
        </select>
      </div>
    </div>
    <div id="container"></div>
    <script id="dynamic-script"></script>
    <script>
      let currentVersion = null;
      let currentComponent = 'visualization';

      const componentConfig = {
        visualization: {
          tagName: 'khiops-visualization',
          demoFile: './demo-visualization.json',
          hasConfig: true,
        },
        covisualization: {
          tagName: 'khiops-covisualization',
          demoFile: './demo-covisualization.json',
          hasConfig: false,
        },
      };

      // Fetch available versions from NPM registry
      async function fetchVersions() {
        try {
          const response = await fetch(
            'https://registry.npmjs.org/khiops-visualization',
          );
          const data = await response.json();
          const versions = Object.keys(data.versions).reverse(); // Latest first
          return versions;
        } catch (error) {
          console.error('Error fetching versions:', error);
          return [];
        }
      }

      // Load script for a specific version
      function loadScript(version) {
        const scriptElement = document.getElementById('dynamic-script');
        const url = version
          ? `https://unpkg.com/khiops-visualization@${version}/khiops-webcomponents.bundle.js`
          : 'https://unpkg.com/khiops-visualization/khiops-webcomponents.bundle.js';

        // Remove old script
        if (scriptElement.src) {
          scriptElement.remove();
          const newScript = document.createElement('script');
          newScript.id = 'dynamic-script';
          newScript.src = url;
          newScript.onload = () => {
            setTimeout(initializeComponent, 500);
          };
          document.body.appendChild(newScript);
        } else {
          scriptElement.src = url;
          scriptElement.onload = () => {
            setTimeout(initializeComponent, 500);
          };
        }
      }

      // Initialize version selector
      async function initVersionSelector() {
        const select = document.getElementById('version-select');
        const versions = await fetchVersions();

        if (versions.length === 0) {
          select.innerHTML =
            '<option value="">Failed to load versions</option>';
          return;
        }

        // Populate select with versions
        select.innerHTML = versions
          .map(
            (version) =>
              `<option value="${version}">${version}${version === versions[0] ? ' (latest)' : ''}</option>`,
          )
          .join('');

        // Set current version to latest
        currentVersion = versions[0];
        select.value = currentVersion;

        // Add change event listener
        select.addEventListener('change', function () {
          const selectedVersion = this.value;
          if (selectedVersion && selectedVersion !== currentVersion) {
            currentVersion = selectedVersion;
            // Reload page without cache
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('v', selectedVersion);
            urlParams.set('t', Date.now());
            window.location.href =
              window.location.href.split('?')[0] + '?' + urlParams.toString();
          }
        });

        // Load the selected version from URL or default to latest
        const urlParams = new URLSearchParams(window.location.search);
        const versionParam = urlParams.get('v');
        if (versionParam && versions.includes(versionParam)) {
          currentVersion = versionParam;
          select.value = currentVersion;
        }

        // Load component from URL parameter
        const componentParam = urlParams.get('component');
        if (componentParam && componentConfig[componentParam]) {
          currentComponent = componentParam;
          updateActiveTab();
        }

        loadScript(currentVersion);
      }

      // Initialize tabs
      function initTabs() {
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach((tab) => {
          tab.addEventListener('click', function () {
            const component = this.getAttribute('data-component');
            if (component !== currentComponent) {
              currentComponent = component;
              updateActiveTab();
              recreateComponent();
            }
          });
        });
      }

      // Update active tab styling
      function updateActiveTab() {
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach((tab) => {
          if (tab.getAttribute('data-component') === currentComponent) {
            tab.classList.add('active');
          } else {
            tab.classList.remove('active');
          }
        });
      }

      // Recreate component based on current selection
      function recreateComponent() {
        const container = document.getElementById('container');
        const config = componentConfig[currentComponent];

        // Clear container
        container.innerHTML = '';

        // Create new component
        const element = document.createElement(config.tagName);
        element.id = 'kv1';
        element.style.width = '100%';
        element.style.height = '100%';
        container.appendChild(element);

        // Wait a bit for component to be ready
        setTimeout(initializeComponent, 500);
      }

      // Wait for the script to load before initializing
      function initializeComponent() {
        loadDemoData();
      }

      // For external CDN script, use DOMContentLoaded as fallback
      // but add additional check for component availability
      document.addEventListener('DOMContentLoaded', function () {
        initTabs();
        recreateComponent(); // Create initial component
        initVersionSelector();
      });

      async function loadDemoData() {
        try {
          const config = componentConfig[currentComponent];
          const response = await fetch(config.demoFile);
          const data = await response.json();

          const element = document.querySelector(config.tagName);
          if (element && typeof element.clean === 'function') {
            element.clean();
            element.setDatas(data);
            if (config.hasConfig) {
              element.setConfig({
                showOpenFileBtn: true,
              });
            }
          } else if (!element) {
            console.error(`${config.tagName} element not found`);
          } else {
            console.error(
              'element.clean is not a function - component not fully initialized',
            );
          }
        } catch (error) {
          console.error('Error loading demo data:', error);
        }
      }
    </script>
  </body>
</html>
